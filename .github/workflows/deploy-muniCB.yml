name: Deploy Municipalidad CB to Server

on:
  push:
    branches:
      - muniCB-deploy

jobs:
  deploy:
    #runs-on: ubuntu-latest
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.5.3
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Deploy to server
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }} << 'EOF'
          if [ ! -d "/var/www/municb/.git" ]; then
            git clone https://github.com/AppchainSolutions/esalud.git /var/www/municb
          else
            cd /var/www/municb
            git pull origin muni-deploy
          fi

          cd /var/www/municb

          # Establece variables de entorno
          echo "DB_CONNECTION=mysql" > .env
          echo "DB_HOST=${{ secrets.DB_HOST }}" >> .env
          echo "DB_PORT=3306" >> .env
          echo "DB_DATABASE=${{ secrets.DB_DATABASE }}" >> .env
          echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" >> .env
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env

          # Asignar la propiedad de las carpetas al usuario del servidor web
          sudo chown -R www-data:www-data /var/www/municb

          # Asignar permisos de lectura y escritura a las carpetas necesarias
          sudo chmod -R 775 /var/www/municb/storage
          sudo chmod -R 775 /var/www/municb/bootstrap/cache

          # Asegurarse de que los archivos tengan los permisos adecuados
          sudo find /var/www/municb -type f -exec chmod 644 {} \;

          # Asegurarse de que las carpetas tengan los permisos adecuados
          sudo find /var/www/municb -type d -exec chmod 755 {} \;

          # Asegurarse de que el archivo .env tenga los permisos adecuados
          sudo chown www-data:www-data /var/www/municb/.env
          sudo chmod 664 /var/www/municb/.env

          # Ejecutar comandos de Artisan para optimizar la aplicaci√≥n
          php artisan migrate --force
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
        EOF