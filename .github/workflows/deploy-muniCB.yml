name: Deploy Municipalidad CB to Server

on:
  push:
    branches:
      - muniCB-deploy

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Test SSH connection
        run: |
          echo "Testing SSH connection..."
          ssh -vvv -o StrictHostKeyChecking=no ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }} "echo 'SSH connection successful'"

      - name: Deploy to server
        run: |
          REPO_BRANCH="muniCB-deploy"
          DEPLOY_PATH="/var/www/municb"

          ssh -o StrictHostKeyChecking=no ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }} << 'EOF'
            set -e
            echo "Starting deployment..."
            if [ ! -d "$DEPLOY_PATH/.git" ]; then
              echo "Creating directory and cloning repository..."
              sudo mkdir -p "/var/www/municb"
              sudo chown ${{ secrets.REMOTE_USER }}:www-data "/var/www/municb"
              git clone --single-branch $REPO_BRANCH https://${{ secrets.GH_PAT }}@github.com/AppChainSolutions/esalud.git /var/www/municb
            else
              echo "Setting permissions for .git directory..."
              sudo chown -R ${{ secrets.REMOTE_USER }}:www-data /var/www/municb/.git
              echo "Pulling latest changes..."
              cd /var/www/municb
              git pull origin muniCB-deploy
            fi

            cd /var/www/municb

            # Asignar la propiedad de las carpetas al usuario del servidor web
            sudo chown -R ${{ secrets.REMOTE_USER }}:www-data /var/www/municb

            # Asignar permisos de lectura y escritura a las carpetas necesarias
            sudo chmod -R 775 /var/www/municb/storage
            sudo chmod -R 775 /var/www/municb/bootstrap/cache

            # Asegurarse de que los archivos tengan los permisos adecuados
            sudo find /var/www/municb/ -type f -exec chmod 644 {} \;

            # Asegurarse de que las carpetas tengan los permisos adecuados
            sudo find /var/www/municb -type d -exec chmod 755 {} \;

            # Asegurarse de que el archivo .env tenga los permisos adecuados
            sudo chown ${{ secrets.REMOTE_USER }}:www-data /var/www/municb/.env
            sudo chmod 664 /var/www/municb/.env

            echo "Modifying composer.json to remove development dependencies..."
            jq 'del(.["autoload-dev"], .["config-dev"], .["dependencies-dev"])' /var/www/municb/composer.json > /var/www/municb/composer.tmp.json && mv /var/www/municb/composer.tmp.json /var/www/municb/composer.json

            # Instalar dependencias de Composer
            echo "Installing Composer production dependencies..."
            composer install --no-dev --working-dir=/var/www/municb

      - name: Set environment variables
        run: |
            # Establece variables de entorno .ENV
            echo "Setting environment variables..."
            echo "APP_NAME=municipalidad/casablanca" > .env
            echo "APP_ENV=production" >> .env
            echo "APP_KEY=base64:yB91h0NIlVel0QLDQnKvdOHpIKqEexzsbv8JUQglzWw=" >> .env
            echo "APP_DEBUG=true" >> .env
            echo "APP_URL=https://vulco.appchain.solutions" >> .env
            echo "LOG_CHANNEL=stack" >> .env
            echo "LOG_DEPRECATIONS_CHANNEL=null" >> .env
            echo "LOG_LEVEL=debug" >> .env
            echo "DB_CONNECTION=pgsql" >> .env
            echo "DB_HOST=localhost" >> .env
            echo "DB_PORT=5432" >> .env
            echo "DB_DATABASE=municb" >> .env
            echo "DB_USERNAME=municb" >> .env
            echo "DB_PASSWORD=40I6jimINanggfopnc0F" >> .env
            echo "BROADCAST_DRIVER=log" >> .env
            echo "CACHE_DRIVER=file" >> .env
            echo "QUEUE_CONNECTION=sync" >> .env
            echo "SESSION_DRIVER=file" >> .env
            echo "SESSION_LIFETIME=120" >> .env

            # Ejecutar comandos de Artisan para optimizar la aplicaci√≥n
            echo "Running Artisan commands..."
            php /var/www/municb/artisan migrate --force
            php /var/www/municb/artisan config:cache
            php /var/www/municb/artisan route:cache
            php /var/www/municb/artisan view:cache

            echo "Clearing cache and optimizing..."
            php /var/www/municb/artisan optimize:clear
            php /var/www/municb/artisan optimize

            echo "Clearing authentication files..."
            php /var/www/municb/artisan auth:clear

            echo "Clearing temporary files..."
            rm -rf /var/www/municb/storage/framework/cache/*
            rm -rf /var/www/municb/storage/framework/sessions/*
            rm -rf /var/www/municb/storage/framework/views/*
            rm -rf /var/www/municb/storage/clockwork/*

            echo "Clearing log files..."
            rm -rf /var/www/municb/storage/logs/*

            echo "Clearing root directory except specific files..."
            find /var/www/municb -mindepth 1 -maxdepth 1 -not -name 'composer.json' -not -name 'artisan' -not -name '.env' -not -name '.' -not -name '..' -exec rm -rf {} +

                        echo "Cleanup complete!"

            echo "Deployment completed successfully."
            EOF